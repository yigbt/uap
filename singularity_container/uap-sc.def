Bootstrap: library
From: ubuntu:18.04
Stage: build

%setup

%files
	environment.yml

%post

    NOW=`date`
    echo "export NOW=\"${NOW}\"" >> $SINGULARITY_ENVIRONMENT

    apt-get update
    # bash needed since the runscript uses sh otherwise which seems
    # insufficient for sourcing the conda shell environment and
    # activation of the env
    apt-get install --yes bash
    apt-get install --yes wget
    apt-get install --yes tar
    apt-get install --yes bzip2
    apt-get install --yes git
    apt-get install --yes gcc
    apt-get install --yes nano
    apt-get install --yes locales
    apt-get install --yes zlibc
    apt-get install --yes librt
    apt-get install --yes libpthread
    apt-get install --yes unzip

    # Configure default locale
    locale-gen de_DE.UTF-8
    locale-gen en_US.UTF-8
    update-locale LANG=de_DE.UTF-8

    # install bcl2fastq
    mkdir tmp/
    cd tmp/
    wget https://files.softwaredownloads.illumina.com/82660c4c-f46c-4743-8566-2437755e4329/bcl2fastq2-v2-20-0-tar.zip?Expires=1606902939&Policy=eyJTdGF0ZW1lbnQiOlt7IlJlc291cmNlIjoiaHR0cHM6Ly9maWxlcy5zb2Z0d2FyZWRvd25sb2Fkcy5pbGx1bWluYS5jb20vODI2NjBjNGMtZjQ2Yy00NzQzLTg1NjYtMjQzNzc1NWU0MzI5L2JjbDJmYXN0cTItdjItMjAtMC10YXIuemlwIiwiQ29uZGl0aW9uIjp7IkRhdGVMZXNzVGhhbiI6eyJBV1M6RXBvY2hUaW1lIjoxNjA2OTAyOTM5fX19XX0_&Signature=nGyULyL7b42LWv-GzdZlHTuARK8su5FEK9UreiSv~R2S20G1eLt5exmXPNMZJJ0UcPDGQ4MbvEIx7fNZXBqWHppAbE-h1cmydCqCS600TMuWYZXQ-PEupQHRbbDkgt3PcpAF0IJw7-q2aehqKJ-hFRptmw-m4TTv7TBPyo9aCp17PYtK2cyuh8iNZu0KmMYvq4ZkhDtNcYHgkd4hlf0v9of8P881d7jpK2crtE-qYGzeiBYS0xlWpv7NgxFIJzgMRBhg8J6i-frHM7McXkHsmFzW1VnayYRWvN04Cx6qEeexKoiIdzraw4RteT757OxmG91VNT3L2zBAiMoYPdIjAg__&Key-Pair-Id=APKAJO3UYWPXK4A26FPQ 2>/dev/null
    unzip bcl2fastq2-v2-20-0-tar.zip
    tar -xzvf bcl2fastq2-v2.20.0.422-Source.tar.gz 2> /dev/null
    cd bcl2fastq/
    mkdir bcl2fastq-build
    cd bcl2fastq-build/
    ../src/configure --prefix=/opt/bcl2fastq
    make
    make install

    # Miniconda3 .. uses python3.7!
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -b -p /usr/local/miniconda3
  
    # COMMENT `source` ging bei mir nicht (keine Ahnung warum)
    # also `.`
    . /usr/local/miniconda3/etc/profile.d/conda.sh

    # COMMENT ich wuerde die packages immer auf einmal installieren 
    # also in einem conda install befehl oder gleich beim conda create
    bash -c ". /etc/profile.d/conda.sh; conda env create -f environment.yml"

    # activate the conda environment
    conda activate uap_python3_v1.0

    # Das repo von uap fÃ¼r Python3 clonen
    git clone --single-branch --branch bcl2fastq https://github.com/yigbt/uap.git /opt/uap
    
    # install uap
    ./opt/uap/bootstrap.sh
   
   # COMMENT create scripts to use qsub/qstat via ssh
   cat > /usr/bin/ssh_dummy.sh << EOF
#!/bin/bash
[[ "\$1" == "-help" ]] && echo "Wrapper for UGE qstat in singularity container."
ssh \$(hostname) \$(basename \$0) \$@ 2> /dev/null
EOF
   chmod ugo+x /usr/bin/ssh_dummy.sh
   ln -s /usr/bin/ssh_dummy.sh /usr/bin/qsub
   ln -s /usr/bin/ssh_dummy.sh /usr/bin/qstat
   
%environment

    export PATH=$PATH:/usr/local/miniconda3/bin
    export PATH=$PATH:/opt/uap
    export BASH_ENV="/usr/local/miniconda3/etc/profile.d/conda.sh"

%runscript

    echo "Container was created on: $NOW"
    echo "Arguments received: $*"
    # COMMENT use bash since sh seems insufficient for conda

    /bin/bash <<EOF
. /usr/local/miniconda3/etc/profile.d/conda.sh
conda activate uap_python3_v1.0

uap $@ 
EOF

%startscript

%test

    grep -q NAME=\"Ubuntu\" /etc/os-release
    if [ $? -eq 0 ]; then
        echo "Container base is Ubuntu as expected."
    else
        echo "Container base is not Ubuntu."
    fi

%labels

    Author Sebastian Canzler
    Version 0.1
    Maintainer Sebastian Canzler
    Contact sebastian.canzler@ufz.de

%help

    Run uap (Universal Analysis Pipeline) with Python 3 support inside this container

    Version 1.0

    The following tools are currently supplied in this singularity container:
    adapterremoval            2.3.1
    bowtie2                   2.4.2
    bwa                       0.7.17
    cufflinks                 2.2.1
    cutadapt                  2.10
    fastqc                    0.11.4
    fastx_toolkit             0.0.14
    hisat2                    2.2.1
    htseq                     0.12.4
    kallisto                  0.46.2
    macs2		      2.2.7.1
    samtools                  1.9
    preseq                    2.0.3
    picard                    2.18.7
    salmon                    1.3.0
    segemehl                  0.3.4
    star                      2.7.6a
    stringtie                 2.1.2
    ucsc-fetchchromsizes      377
